---
title: "Writing conda recipes"
subtitle: "Practical"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  xaringan::moon_reader:
	self-contained: true
	seal: false
	css: ["default", "template.css"]
	nature:
	  slideNumberFormat: ""
---

layout: true
<div class="scilife-logo"></div>
<div class="nbis-logo"></div>

---

class: center, middle

.HUGE[Writing conda recipes]

.Large[Practical session]

.Large[2022-11-17]

.Large[Per Unneberg]


```{r Setup, echo = FALSE, message = FALSE}
# Knitr setup
knitr::opts_chunk$set(message = FALSE,
					  warning = FALSE)

# Load packages
library("dplyr")
library("kableExtra")
```

---

# Writing Conda recipes

## Objective

Go through steps needed to write a bioconda recipe for a tool you
would like to add. We will be working with tools that are available on
bioconda so there is a "solution" for comparison.

--

## Setup

```{bash setup, eval=FALSE }
mkdir -p exercises
```

---

# Conda packages<sup>1</sup>

````{verbatim}
$ tree -A recipes/bioawk
recipes/bioawk/
├── build.sh
└── meta.yaml
````

--

- `meta.yaml` is required

--

- optional:

--

  - `build.sh`

--

  - (small) test files

--

  - license file


.footnote[
.small[[1] cf https://bioconda.github.io/tutorials/gcb2020.html]]


---

# Important meta.yaml sections

--

- `package`: name and version

--

- `source`: url and SHA256/MD5 checksums

--

- `build`: build number, platforms to skip, “noarch” information

--

- `requirements`: packages for building, linking, running

--

- `test`: commands/imports

--

- `about`: webpage, license, summary of what the package does

--

- `extras`: comments, maintainers, etc.


---

# Example 1 - bioawk

## Objective

Write recipe for bioawk whose source code is found at
https://github.com/lh3/bioawk

--

## Setup

```{bash setup-e1 , eval=FALSE}
mkdir -p exercises/e1
cd exercises/e1
```


---

# 1. Edit the meta file


Start by creating a directory for the recipe:

```{bash, eval=FALSE }
mkdir -p bioawk
```

--

and open the file `bioawk/meta.yaml` in an editor. Following conda documentation<sup>1</sup>, we need to complete the following template:

````{verbatim, lang="YAML" }
package:
  name:
  version:

source:
  url:
  sha256:

requirements:
  build:
	-

  run:
	-

test:
  commands:
	-

about:
  home:
````

.footnote[
.small[[1] https://docs.conda.io/projects/conda-build/en/latest/user-guide/tutorials/build-pkgs.html#editing-the-meta-yaml-file]]

---

# 2. Get tarball metadata

The conda package will be built from a tarball that we download from
the repo. We need to provide the recipe with a .green[url] and a
.green[sha256] checksum.

Click on the releases link to the right on the repo home page. This
should bring you to [https://github.com/lh3/bioawk/releases](https://github.com/lh3/bioawk/releases)

--

Click on the tarball link [Source code
(tar.gz)](https://github.com/lh3/bioawk/archive/refs/tags/v1.0.tar.gz)
to download the tarball.
```{bash e1-download-bioawk, echo=FALSE }
if [ ! -e bioawk.v1.0.tar.gz ]; then
	wget https://github.com/lh3/bioawk/archive/refs/tags/v1.0.tar.gz -O bioawk.v1.0.tar.gz 2>/dev/null
fi
```


Run sha256 on the tarball and record the output:

```{bash e1-tarball-sha256 }
sha256sum bioawk.v1.0.tar.gz
```

--

Now we can add this to the .green[source] section in the meta.yaml
file, along with .green[package name] and .green[version] number:


````{verbatim}
package:
  name: bioawk
  version: "1.0"

source:
  url: https://github.com/lh3/bioawk/archive/v1.0.tar.gz
  sha256: 5cbef3f39b085daba45510ff450afcf943cfdfdd483a546c8a509d3075ff51b5
````

---


# 3. Clone the repo

Next we need to know how to compile the repo and gather information
about dependencies and requirements.

Start by cloning the repo:

```{bash, eval=FALSE }
git clone git@github.com:lh3/bioawk.git bioawk.git
ls bioawk.git | head -5
```

```{bash list-bioawk, echo=FALSE}
if [ ! -e exercises/e1/bioawk.git ]; then
	git clone git@github.com:lh3/bioawk.git exercises/e1/bioawk.git
fi
ls exercises/e1/bioawk.git | head -5
```
--

There is a README.md that hopefully provides installation
instructions, and a Makefile that contains instructions to compile the
package. If we scroll through the former, we will find the following
information:

```{bash e1-head-readme, echo=FALSE }
head -12 exercises/e1/bioawk.git/README.md | tail -3
```

--

.green[bison] and .green[libz] are two dependencies.

---

# Add dependencies

Add the dependencies .green[bison] and .green[libz] to the
.green[requirements] section, .green[build] keyword:

````{verbatim}
package:
  name: bioawk
  version: "1.0"

source:
  url: https://github.com/lh3/bioawk/archive/v1.0.tar.gz
  sha256: 5cbef3f39b085daba45510ff450afcf943cfdfdd483a546c8a509d3075ff51b5

requirements:
  build:
	- zlib
	- bison
````

---

# 4. Inspect build instructions

Examine the Makefile and look for the .green[bioawk] target; linked
packages are defined with the .green[-l] option:

````{verbatim}
bioawk:ytab.o $(OFILES)
	$(CC) $(CFLAGS) ytab.o $(OFILES) $(ALLOC) -o $@ -lm -lz
````




---

# Example 2 - python package

---

# Example 3 - R package

